project: "my-app"

environments:
  production:
    ssh:
      host: "prod.example.com"
      user: "deploy"
      key_path: "~/.ssh/deploy_key"
      port: 22

    remote_path: "/var/www/app"

    # Paths to persist between releases (persistent storage, uploads, etc.)
    # These will be symlinked to a persistent 'shared/' directory
    shared_paths:
      - "app/public/uploads"
      - "app/storage/logs"

    builds:
      php:
        enabled: true
        root: "api"
        composer_command: "composer install --no-dev --optimize-autoloader"

      go:
        enabled: false
        root: "cmd/api"
        target_os: "linux"
        target_arch: "amd64"
        binary_name: "api-server"

      frontend:
        enabled: true
        root: "theme"
        compile_command: "npm run build"
        npm_command: "pnpm install"
        cleanup_dev_deps: true
        production_command: "pnpm install --production"

    # Hooks to run on remote server after symlink switch
    # These run automatically inside the 'app/' directory of the new release
    post_deploy:
      - "php versaCLI cache:clear"
      - "php versaCLI routes:compile"

    ignored_paths:
      - ".git"
      - "deploy.yml"
      - ".vscode"
      - "src"
      - "tests"
      - "node_modules/.cache"

  staging:
    ssh:
      host: "staging.example.com"
      user: "deploy"
      key_path: "~/.ssh/deploy_key"

    remote_path: "/var/www/staging"

    builds:
      php:
        enabled: true
        composer_command: "composer install --no-dev"

      go:
        enabled: true
        target_os: "linux"
        target_arch: "amd64"
        binary_name: "api-server"

      frontend:
        enabled: true
        compile_command: "./compiler.sh {file}"
        npm_command: "npm ci"

    post_deploy:
      - "php /var/www/staging/current/app/clear-cache.php"

    ignored_paths:
      - ".git"
      - "tests"
